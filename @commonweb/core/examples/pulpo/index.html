<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Todo App</title>
</head>
<script src="https://cdn.tailwindcss.com"></script>

<style>
    html, body {
        height: 100%;
        width: 100%;
    }

    .header {
        height: 60px;
        border-bottom: 2px solid #f2f2f2;
    }

    .content {
        padding: 1rem 3rem;
        background: white
        height: calc(92%);
    }

    .layout {
        overflow: hidden;
        height: 100%;
        display: flex;
        overflow: hidden;
        width: 100%;
    }

    .sidebar {
        display: flex;
        width: 100%;
        background: var(--bg-primary);
        flex: 0.2;
        transition-property: flex;
        transition-duration: 0.5s;
        justify-center: center;
        overflow: hidden;
        border-right: 2px solid #f2f2f2;
    }

    .sidebar.collapsed {
        transition-property: flex;
        transition-duration: 0.5s;
        flex: 0;
    }

    .collapsed {
        flex: 0;

    }
</style>
<body>
<div class="layout">
    <div class="sidebar">
        <template-view
                data='{"routes":[
                    {"name":"Productos","route":"products","icon":"restaurant"},
                    {"name":"Tiendas", "route":"stores","icon":"storefront"},
                    {"name":"Calendario de Ordenes", "route":"orders-calendar","icon":"sell"}

                ]}'
                src="http://localhost:63342/common-web/@commonweb/core/examples/pulpo/sidebar.html"
        ></template-view>
    </div>
    <div style="flex:1;overflow:hidden;">
        <div class="header">
            TOCa
        </div>
        <div class="content">
            <!-- Usaer templates para los conditional asi evita ser renderizado           -->
            <conditional-render-cases routes case="orders-calendar">
                <div case="stores">
                    <template>
                        <template-view
                                data='{"entity":"products"}'
                                src="http://localhost:63342/common-web/@commonweb/core/examples/pulpo/stores/listing-page.html"
                        ></template-view>
                    </template>
                </div>
                <div case="products">
                    <template>
                        <template-view
                                data='{"entity":"products"}'
                                src="http://localhost:63342/common-web/@commonweb/core/examples/pulpo/products/listing-page.html"
                        ></template-view>
                    </template>
                </div>
                <div case="orders-calendar">
                    <template>
                        <template-view
                                data='{"entity":"products"}'
                                src="http://localhost:63342/common-web/@commonweb/core/examples/pulpo/reports/orders-calendar.html"
                        ></template-view>
                    </template>
                </div>
            </conditional-render-cases>


        </div>
    </div>

</div>


<script src="../../dist/lib-pkg.js" type="text/javascript"></script>
<script async src="../form.plugin.js" type="text/javascript"></script>
<script async>

    function generateMonthDaysArray(startDate, endDate) {
        const months = [];
        let startMonth = new Date(startDate).getMonth();
        const endMonth = new Date(endDate).getMonth();
        const startYear = new Date(startDate).getFullYear();
        const endYear = new Date(endDate).getFullYear();
        const diasSemana = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];

        for (let year = startYear; year <= endYear; year++) {
            for (let month = startMonth; month <= endMonth; month++) {
                const monthName = new Date(year, month, 1).toLocaleDateString("es-ES", {month: "long"});
                const days = [];

                for (let day = 1; day <= new Date(year, month + 1, 0).getDate(); day++) {
                    days.push({
                        weekDay: diasSemana[new Date(year, month, day).getDay()],
                        day: day,
                        date: new Date(year, month, day).toLocaleDateString("es-ES"),
                    });
                }

                months.push({
                    month: monthName,
                    days,
                });
            }

            startMonth = 0;
        }

        return months;
    }

    window
        .RegisterWebComponent({
            // language=CSS
            style: `
                .day {
                    border: 1px solid lightgray;
                    height: 10vh;
                    width: 10vh;
                    max-height: 125px;
                }

                .day-counter {
                    padding: 5px;
                }

                .week-day {
                    border: 1px solid lightgray;

                }

                .grid {
                    display: grid;
                    grid-template-columns: repeat(7, 10vh);
                    grid-gap: 0em;
                }
            `,
            selector: 'pulpo-calendar',
            // language=HTML
            template: `
                <!--                <data-context>-->
                <template-view>
                    <div class="main-calendar">
                        <template for-each="{{@host.data.months}}">
                            <div calendar-days class="grid">
                                <template for-each="{{@host.data.daysOfWeek}}">
                                    <h4 class='week-day'>{{@host.data}}</h3>
                                </template>
                            </div>
                            <div class='grid'>
                                <template day-template for-each="{{@host.data.days}}">
                                    <div class='day'>
                                        <div data="{{@host.data}}" class='day-counter'>{{@host.data.day}}</div>
                                        <div>
                                            <template-view
                                                    show="event"
                                                    data="{{@host.data}}"
                                                    src="http://localhost:63342/common-web/@commonweb/core/examples/pulpo/reports/calendar-day.html">

                                            </template-view>
                                        </div>
                                        <bind-element input-src="template-view:[data]" from="div.day:(click)"
                                                      to="@host:bubbleUp">
                                            <bind-element>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </template-view>
                <!--                </data-context>-->

            `,
            // so we can take global style rules
        })
        .with_attribute("html", "<h4>{{@host.data.event.ordersCompleted}} Ordenes Completadas</h4>\n>")
        .with_attribute("template", "")
        .with_attribute("months", function (data) {
            const main = this.shadowRoot.querySelector("template-view");
            main.setData(data);

        })
        .with_method("bubbleUp", function (value) {
            this.dispatchEvent(new CustomEvent("day-clicked", {detail: value}))
            console.log(value)
        })
        .with_attribute("daysOfWeek", [])
        .with_attribute("data", function (data) {
            if (!data || data.length === 0) {
                return;
            }

            //Sort
            const sortedByDate = data.sort(({date: dateA}, {date: dateB}) => {
                const a = new Date(dateA);
                const b = new Date(dateB);
                return a - b; // Ordena ascendente
                // return b - a; // Ordena descendente

            });
            const months = generateMonthDaysArray(sortedByDate[0][this['date-path']], sortedByDate[sortedByDate.length - 1][this['date-path']]);
            // For each month need to add a Month
            // for each day of the month ned to add a Day
            const monthsData = []
            for (const month of months) {
                // need to merge days
                const merged = month.days.map(({day, weekDay}) => {
                    const event = data.find(t => new Date(t[this['date-path']]).getDate() + 1 === day);
                    return {day, weekDay, event}
                })


                // const forEach = node.querySelector("for-each[main]");
                // forEach.data(merged);
                // const forEachDays = node.querySelector("for-each[daysweek]");
                const daysOfWeek = [
                    merged[0].weekDay,
                    merged[1].weekDay,
                    merged[2].weekDay,
                    merged[3].weekDay,
                    merged[4].weekDay,
                    merged[5].weekDay,
                    merged[6].weekDay,

                ];

                monthsData.push(
                    {
                        days: merged,
                        daysOfWeek,
                    }
                )
                // this.shadowRoot.querySelector("data-context").state = toPass;

            }

            this['months'](monthsData)

        })
        .with_attribute("date-path", 'date')// path to property that is gonna be used as the day
        .build();


</script>
</body>
</html>
